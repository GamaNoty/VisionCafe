{% extends 'layout/base.html' %}
{% load static %}
{% load qr_code %}
{% block title %} Stůl {{ table.number }} | Objednávka{% endblock %}
{% block extra_css %} <link rel="stylesheet" href="{% static 'css/table.css' %}"/>{% endblock %}
{% block content %}
<div class="card text-center">
  <h1>Stůl {{ table.number }}</h1>

  <div class="qr-section">
    {% qr_from_text full_url size="M" border=2 %}
    <p class="small-gray">Naskenujte pro rychlou objednávku z tohoto stolu</p>
  </div>

  <div class="order-form">
    <form method="post" id="order-form">
      {% csrf_token %}

      <label class="product-select" for="product-select"
        >Na co máte chuť?</label
      >
      <select id="product-select" class="mb-2">
        <option value="" selected disabled>Vyberte kategorii...</option>
        {% for product in products %}
        <option value="{{ product.id }}">{{ product.name }}</option>
        {% endfor %}
      </select>

      <label for="product-type-select">Upřesněte výběr:</label>
      <select name="product_type" id="product-type-select" disabled>
        <option value="" selected disabled>
          Nejdříve vyberte kategorii...
        </option>
      </select>

      <button type="submit" id="submit-btn" class="mt-1" disabled>
        Odeslat objednávku
      </button>
    </form>
  </div>

  <script id="product-data" type="application/json">
    {
        {% for product in products %}
            "{{ product.id }}": [
                {% for pt in product.types.all %}
                    {"id": "{{ pt.id }}", "name": "{{ pt.name }}"}
                    {% if not forloop.last %},
                    {% endif %}
                {% endfor %}
            ]{% if not forloop.last %},{% endif %}
        {% endfor %}
    }
  </script>
</div>

<div class="card mt-2">
  <h3>Vaše dnešní objednávky</h3>
  <table class="history-table">
    <tbody>
      {% for order in orders %}
      <tr>
        <td>
          <strong>{{ order.product_type }}</strong><br />
          <small class="small-gray">{{ order.created_at|date:"H:i" }}</small>
        </td>
        <td class="text-right">
          {% include 'orders/includes/status_badge.html' %}
        </td>
        <td>
          <div class="order-item">
            {{ order.product_type }} - {{ order.get_status_display }}
            {% if order.status == 'PENDING' %}
                <a id="cancel-button" href="{% url 'customer_cancel_order' order.id %}">
                   (Zrušit)
                </a>
            {% endif %}
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="2" class="text-center small-gray">
          Zatím jste si nic neobjednali.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
  const productSelect = document.getElementById("product-select");
  const typeSelect = document.getElementById("product-type-select");
  const submitBtn = document.getElementById("submit-btn");
  const productData = JSON.parse(
    document.getElementById("product-data").textContent,
  );

  productSelect.addEventListener("change", function () {
    const productId = this.value;
    const types = productData[productId] || [];

    typeSelect.innerHTML =
      '<option value="" selected disabled>Vyberte konkrétní druh...</option>';

    types.forEach((type) => {
      const option = document.createElement("option");
      option.value = type.id;
      option.textContent = type.name;
      typeSelect.appendChild(option);
    });

    typeSelect.disabled = false;
    submitBtn.disabled = true;
  });

  typeSelect.addEventListener("change", function () {
    submitBtn.disabled = false;
  });
</script>
{% endblock %}
